<div class="create-container">
    <header class="page-header">
        <h1>{{ isEditMode ? 'Edit Preset' : 'Create New Preset' }}</h1>
        <a routerLink="/" class="back-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>Back to List</a>
    </header>

    <div *ngIf="error" class="error-message">
        {{ error }}
    </div>

    <form (ngSubmit)="onSubmit()" class="preset-form">
        <div class="form-group">
            <label for="name">Preset Name *</label>
            <input type="text" id="name" [(ngModel)]="preset.name" name="name" required
                placeholder="e.g. My Awesome Kit" [class.invalid]="!preset.name && error">
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <select id="category" [(ngModel)]="preset.category" name="category">
                <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
            </select>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" [(ngModel)]="preset.description" name="description" rows="4"
                placeholder="Describe your preset..."></textarea>
        </div>

        <div class="sounds-section">
            <h3>Sounds</h3>

            <div class="sound-list">
                <div *ngFor="let sound of preset.sounds; let i = index" class="sound-item">
                    <div class="sound-info">
                        <span class="pad-badge">Pad {{ sound.pad }}</span>
                        <span class="sound-name">{{ sound.name }}</span>
                        <span class="sound-url">{{ sound.url }}</span>
                    </div>
                    <button type="button" class="remove-sound-btn" (click)="removeSound(i)"
                        title="Remove sound"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>

                <div *ngIf="!preset.sounds || preset.sounds.length === 0" class="no-sounds">
                    No sounds added yet.
                </div>
            </div>

            <div class="add-sound-form">
                <h4>Add New Sound</h4>
                
                <!-- Source Type Tabs -->
                <div class="source-tabs">
                    <button type="button" 
                        class="source-tab" 
                        [class.active]="addSoundMode === 'url'"
                        (click)="addSoundMode = 'url'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>URL
                    </button>
                    <button type="button" 
                        class="source-tab" 
                        [class.active]="addSoundMode === 'upload'"
                        (click)="addSoundMode = 'upload'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Upload File
                    </button>
                    <button type="button" 
                        class="source-tab" 
                        [class.active]="addSoundMode === 'record'"
                        (click)="addSoundMode = 'record'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>Record
                    </button>
                </div>

                <!-- URL Mode -->
                <div class="add-sound-grid" *ngIf="addSoundMode === 'url'">
                    <div class="form-group">
                        <label>Pad (0-15)</label>
                        <input type="number" [(ngModel)]="newSound.pad" name="newPad" min="0" max="15">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" [(ngModel)]="newSound.name" name="newName" placeholder="Kick">
                    </div>
                    <div class="form-group full-width">
                        <label>URL</label>
                        <input type="text" [(ngModel)]="newSound.url" name="newUrl" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="add-btn" (click)="addSound()">Add Sound</button>
                    </div>
                </div>

                <!-- Upload Mode -->
                <div class="add-sound-grid" *ngIf="addSoundMode === 'upload'">
                    <div class="form-group">
                        <label>Pad (0-15)</label>
                        <input type="number" [(ngModel)]="newSound.pad" name="uploadPad" min="0" max="15">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" [(ngModel)]="newSound.name" name="uploadName" placeholder="Sound name">
                    </div>
                    <div class="form-group full-width">
                        <label>Audio File</label>
                        <div class="file-upload-zone" 
                            (click)="fileInput.click()"
                            (drop)="onFileDrop($event)"
                            (dragover)="onDragOver($event)"
                            (dragleave)="onDragLeave($event)"
                            [class.dragging]="isDragging">
                            <input #fileInput type="file" 
                                accept="audio/*" 
                                (change)="onFileSelected($event)"
                                style="display: none">
                            <span class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></span>
                            <span *ngIf="!selectedFile">Click or drag audio file here</span>
                            <span *ngIf="selectedFile" class="selected-file">{{ selectedFile.name }}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="add-btn" 
                            (click)="uploadAndAddSound()" 
                            [disabled]="!selectedFile || isUploading">
                            {{ isUploading ? 'Uploading...' : 'Upload & Add' }}
                        </button>
                    </div>
                </div>

                <!-- Record Mode -->
                <div class="add-sound-grid" *ngIf="addSoundMode === 'record'">
                    <div class="form-group">
                        <label>Pad (0-15)</label>
                        <input type="number" [(ngModel)]="newSound.pad" name="recordPad" min="0" max="15">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" [(ngModel)]="newSound.name" name="recordName" placeholder="Sound name">
                    </div>
                    <div class="form-group full-width">
                        <label>Recording</label>
                        <div class="record-zone">
                            <div class="record-status" [class.recording]="isRecording">
                                <span class="record-dot"></span>
                                <span *ngIf="!isRecording && !recordedBlob">Ready to record</span>
                                <span *ngIf="isRecording">Recording... {{ recordingTime }}s</span>
                                <span *ngIf="!isRecording && recordedBlob">Recording ready ({{ recordingDuration }}s)</span>
                            </div>
                            <div class="record-controls">
                                <button type="button" 
                                    class="record-btn" 
                                    [class.recording]="isRecording"
                                    (click)="toggleRecording()">
                                    <ng-container *ngIf="isRecording"><svg viewBox="0 0 24 24" fill="currentColor" stroke="none" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><rect x="6" y="6" width="12" height="12"/></svg>Stop</ng-container>
                                    <ng-container *ngIf="!isRecording"><span class="record-dot"></span> Record</ng-container>
                                </button>
                                <button type="button" 
                                    class="play-recorded-btn" 
                                    *ngIf="recordedBlob && !isRecording"
                                    (click)="playRecordedSound()">
                                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="none" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><polygon points="5 3 19 12 5 21 5 3"/></svg>Preview
                                </button>
                                <button type="button" 
                                    class="clear-recorded-btn" 
                                    *ngIf="recordedBlob && !isRecording"
                                    (click)="clearRecording()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;vertical-align:middle;margin-right:4px"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="add-btn" 
                            (click)="uploadRecordingAndAdd()" 
                            [disabled]="!recordedBlob || isUploading">
                            {{ isUploading ? 'Uploading...' : 'Save Recording' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" routerLink="/" class="cancel-btn">Cancel</button>
            <button type="submit" class="submit-btn" [disabled]="isLoading">
                {{ isLoading ? 'Saving...' : (isEditMode ? 'Update Preset' : 'Create Preset') }}
            </button>
        </div>
    </form>
</div>